- name:                       Register current db2 version
  shell:                      runuser -l "{{ __db2_user }}" -c 'db2level' | grep "DB2 v" | cut -d'"' -f 2
  register:                   db2_installed_version
  ignore_errors:              true
  delegate_to:               "{{ item }}"
  with_items:
   - "{{ groups['db2_servers'] }}"

- debug:
    msg:                      "Installed DB2 version is {{ db2_installed_version.results[0].stdout_lines }}"
  delegate_to:               "{{ item }}"
  with_items:
   - "{{ groups['db2_servers'] }}"

- name:                       "Check if existing DB2 installed version is same as expected one to be installed"
  shell:                      grep -iq {{ __install_version_db2 }} <<< {{ db2_installed_version.results[0].stdout_lines }} && echo "true" || echo "false"
  register:                   db2_version_match
  ignore_errors:              true
  delegate_to:               "{{ item }}"
  with_items:
   - "{{ groups['db2_servers'] }}"

- name:                       "Reset DB2 variables to fallback to v11.1 instead of the target version {{ __install_version_db2 }}"
  set_fact:
    __db2_default_jdbc_location: "/opt/IBM/db2/V11.1/java"
  delegate_to: "{{ item }}"
  with_items: "{{ play_hosts }}"
  run_once: yes
  when:
    - not db2_version_match.results[0].stdout|bool
    - db2_installed_version.results[0].stdout_lines is search("11\\.1")

- name:                       "Reset DB2 variables to fallback to v11.5 instead of the target version {{ __install_version_db2 }}"
  set_fact:
    __db2_default_jdbc_location: "/opt/IBM/db2/V11.5/java"
  delegate_to: "{{ item }}"
  with_items: "{{ play_hosts }}"
  run_once: yes
  when:
    - not db2_version_match.results[0].stdout|bool
    - db2_installed_version.results[0].stdout_lines is search("11\\.5")

- name:                       "Reset DB2 variables to fallback to v12.1 instead of the target version {{ __install_version_db2 }}"
  set_fact:
    __db2_default_jdbc_location: "/opt/IBM/db2/V12.1/java"
  delegate_to: "{{ item }}"
  with_items: "{{ play_hosts }}"
  run_once: yes
  when:
    - not db2_version_match.results[0].stdout|bool
    - db2_installed_version.results[0].stdout_lines is search("12\\.1")
