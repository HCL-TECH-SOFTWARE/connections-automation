---
- name:              Encode Password XOR
  shell:             "echo \"xpw={{ was_password }}\" > {{__logs_dir}}/xor.props && {{__was_install_location}}/bin/PropFilePasswordEncoder.sh {{__logs_dir}}/xor.props xpw > /dev/null && cat {{__logs_dir}}/xor.props | awk -F= '{ printf $2\"=\"}'"
  register:          __xor_encoded_password
  changed_when:      ( __xor_encoded_password.rc == 0)

- name:              Encode WAS Password
  command:           "{{ __iim_install_location }}/eclipse/tools/imutilsc encryptString {{ was_password }} -silent -noSplash"
  register:          __was_encoded_password
  changed_when:      ( __was_encoded_password.rc == 0)

- name:              Encode DB Passwords
  command:           "{{ __iim_install_location }}/eclipse/tools/imutilsc encryptString {{ item.pw }} -silent -noSplash"
  register:          __cnx_db_info_results
  with_items:        "{{ __cnx_db_info }}"
  changed_when:      false

- name:              Encode CCM Password
  command:           "{{ __iim_install_location }}/eclipse/tools/imutilsc encryptString {{ ccm_password }} -silent -noSplash"
  register:          __ccm_encoded_password
  changed_when:      ( __ccm_encoded_password.rc == 0)
  when:              ( ccm_install is defined )

- name:              Encode DB Passwords for CCM
  command:           "{{ __iim_install_location }}/eclipse/tools/imutilsc encryptString {{ item.pw }} -silent -noSplash"
  register:          __ccm_db_info_results
  with_items:        "{{ __ccm_db_info }}"
  when:              ( ccm_install is defined )

- name:              Generate Response file {{ __rsp_file }} from {{ __tpl_file }}
  template:
    src:             "{{ __tpl_file }}"
    dest:            "{{ __rsp_file }}"

- name:              Disable Repository on Installation Manager
  replace:
    path:            /var/ibm/InstallationManager/.settings/com.ibm.cic.agent.core.prefs
    regexp:          '(\s*)RepositoryIsOpen=true(\s*)'
    replace:         '\1RepositoryIsOpen=false\2'
    backup:          yes
  ignore_errors:     true

- name:              "Change SOAP request timeout in {{ __was_install_location }}/profiles/{{ __profile_name }}/properties/soap.client.props"
  replace:
    path:            "{{ __was_install_location }}/profiles/{{ __profile_name }}/properties/soap.client.props"
    regexp:          '(\s*)com.ibm.SOAP.requestTimeout=180(\s*)'
    replace:         '\1com.ibm.SOAP.requestTimeout=600\2'
    backup:          yes
  ignore_errors:     true

- name:              Clean Connections Install Dir
  file:
    state:           absent
    path:            "{{ __cnx_install_location }}/"
  ignore_errors:     true
  when:              not cnx_updates_enabled

- name:              Create Connections CTEMP dir if it does not exist
  file:
    path:            "{{ __cnx_tempdir }}"
    state:           directory
    mode:            '0755'
    
# Changed for shell for CCM
- name:              Install Connections Software
  shell: "{{ __iim_install_location }}/eclipse/tools/imcl -acceptLicense -sVP -log {{ __log_file }} input {{ __rsp_file }}"
  environment:
    IATEMPDIR: "{{ __cnx_tempdir }}"
    CHECK_DISK_SPACE: OFF
  register:          cout


- name:              Cleanup Binaries directory
  file:
    state:           absent
    path:            "{{ __tmp_dir }}/{{ item }}"
  with_items:
    - cnx
    - cnx-cr
